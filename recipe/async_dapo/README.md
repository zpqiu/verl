# Async DAPO with Interruption Mechanism

è¿™æ˜¯ä¸€ä¸ªåŸºäºæ‰“æ–­æœºåˆ¶çš„å¼‚æ­¥DAPO (Direct Alignment with Preference Optimization) å¼ºåŒ–å­¦ä¹ æ–¹æ³•çš„å®ç°ã€‚è¯¥æ–¹æ³•é€šè¿‡åŠ¨æ€ä»»åŠ¡è°ƒåº¦ã€æ—©åœæœºåˆ¶å’Œè¯·æ±‚æ‰“æ–­ç­‰æŠ€æœ¯ï¼Œæ˜¾è‘—æå‡äº†å¤§æ¨¡å‹è®­ç»ƒçš„æ•ˆç‡å’Œèµ„æºåˆ©ç”¨ç‡ã€‚

## ğŸš€ ä¸»è¦ç‰¹æ€§

- **å¼‚æ­¥Rolloutæœºåˆ¶**: ä½¿ç”¨veRL çš„å¼‚æ­¥ Rollout engine
- **åŠ¨æ€ä»»åŠ¡åˆ›å»º**: æ ¹æ®æœåŠ¡å™¨è´Ÿè½½åŠ¨æ€åˆ†é…ä»»åŠ¡ï¼Œæé«˜èµ„æºåˆ©ç”¨ç‡
- **å’Œ DAPO ç»“åˆçš„æ—©åœç­–ç•¥**: åœ¨æ¯ä¸ª prompt rollout ç»“æŸæ—¶ç«‹å³è®¡ç®— reward æ–¹å·®ï¼Œå¹¶åœ¨æ”¶é›†åˆ°ä¸€ä¸ª batch åï¼Œåˆ™åœæ­¢ rollout æ¥é¿å…æ— æ•ˆè®¡ç®—

## ğŸ› ï¸ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒé…ç½®

```bash
# å®‰è£…åŸºæœ¬ä¾èµ–
pip install -e . 
pip install -U math-verify[antlr4_9_3]

# è®¾ç½®ç¯å¢ƒå˜é‡
export WANDB_API_KEY=<WANDB_API_KEY>
export MODEL_PATH=<MODEL_PATH>
export VLLM_USE_V1=1
export HOME_DIR=<PATH_TO_HOME>
```

### 2. æ•°æ®å‡†å¤‡

```bash
# åˆ›å»ºå­˜å‚¨ç›®å½•
mkdir -p <PATH_TO_HOME>/data/skywork_or1_1_5b_diff_sys
mkdir -p <PATH_TO_HOME>/data/aime24_sys

# è¿è¡Œæ•°æ®é›†æ„å»ºè„šæœ¬
python3 recipe/async_dapo/process_skywork.py --local_dir <PATH_TO_HOME>/data/skywork_or1_1_5b_diff_sys 
python3 recipe/async_dapo/process_aime24.py --local_dir <PATH_TO_HOME>/data/aime24_sys
```

### 3. è¿è¡Œè®­ç»ƒ

```bash
# å¯åŠ¨math verify server
nohup python3 recipe/async_dapo/math_verify_service.py > /dev/null 2>&1 &

# è¿è¡Œè®­ç»ƒè„šæœ¬
bash recipe/async_dapo/test_7b.sh
```

## âš™ï¸ æ ¸å¿ƒé…ç½®å‚æ•°

### å¼‚æ­¥Rollouté…ç½®
```bash
# æ¯ä¸ªpromptç”Ÿæˆçš„å›å¤æ•°é‡
n_resp_per_prompt=16

# åŠ¨æ€ä»»åŠ¡åˆ›å»ºé—´éš”ï¼ˆç§’ï¼‰
batch_creation_interval=10

# æ¯ä¸ªæœåŠ¡å™¨æœ€å¤§å¹¶å‘æ•°
max_concurrent_per_server=512
```

### RewardCompletionCallback è‡ªå®šä¹‰å›è°ƒ
æœ¬å®ç°é‡‡ç”¨äº†è‡ªå®šä¹‰çš„`RewardCompletionCallback`æ¥å¤„ç†ç”Ÿæˆç»“æœçš„å®æ—¶è¯„åˆ†ï¼š

- **å®æ—¶è¯„åˆ†**: æ¯å½“æ¨¡å‹å®Œæˆä¸€ä¸ªå›å¤ç”Ÿæˆæ—¶ï¼Œç«‹å³è°ƒç”¨å¤–éƒ¨çš„`math_verify_service`è¿›è¡Œæ•°å­¦é—®é¢˜éªŒè¯å’Œè¯„åˆ†
- **å¹¶å‘æ§åˆ¶**: é€šè¿‡Semaphoreé™åˆ¶åŒæ—¶è¿›è¡Œçš„è¯„åˆ†è¯·æ±‚æ•°é‡ï¼Œé¿å…è¿‡è½½å¤–éƒ¨æœåŠ¡
- **é‡è¯•æœºåˆ¶**: æ”¯æŒæŒ‡æ•°é€€é¿çš„é‡è¯•ç­–ç•¥ï¼Œæé«˜æœåŠ¡å¯é æ€§
- **è¯„åˆ†ç»“æœ**: è¿”å›score(åˆ†æ•°)ã€accuracy(å‡†ç¡®ç‡)å’Œprediction(é¢„æµ‹ç»“æœ)ä¸‰ä¸ªç»´åº¦çš„è¯„ä»·æŒ‡æ ‡
- **æ•°æ®åå¤„ç†**: åœ¨`postprocess`é˜¶æ®µå¤„ç†tokenåŒ–ã€å¡«å……å’Œæ©ç ç”Ÿæˆç­‰æ“ä½œ


## ğŸ—ï¸ æ¶æ„è®¾è®¡

### 1. æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     DAPO Trainer                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                AsyncLLMServerManager                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ AsyncServer 0 â”‚ â”‚ AsyncServer 1 â”‚ â”‚ AsyncServer N â”‚    â”‚
â”‚  â”‚  (vLLM/SGLang)â”‚ â”‚  (vLLM/SGLang)â”‚ â”‚  (vLLM/SGLang)â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                ChatCompletionScheduler                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚             Dynamic Task Creator                    â”‚   â”‚
â”‚  â”‚  â€¢ Load-aware task allocation                      â”‚   â”‚
â”‚  â”‚  â€¢ Batch creation with intervals                   â”‚   â”‚
â”‚  â”‚  â€¢ Early stop signal handling                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚             Task Queue Manager                      â”‚   â”‚
â”‚  â”‚  â€¢ Concurrent task processing                      â”‚   â”‚
â”‚  â”‚  â€¢ Score variance-based validation                â”‚   â”‚
â”‚  â”‚  â€¢ Request interruption support                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. å¼‚æ­¥Rolloutæµç¨‹å›¾

```mermaid
graph TD
    A["AsyncLLMServerManager.generate_sequences()<br/>ä¸»å…¥å£"] --> B["ChatCompletionScheduler.generate_sequences()"]
    
    B --> C["åˆå§‹åŒ–é…ç½®<br/>- é‡‡æ ·å‚æ•°<br/>- æ—©åœé˜ˆå€¼<br/>- ä»»åŠ¡é˜Ÿåˆ—<br/>- RewardCompletionCallback"]
    
    C --> D["åˆ›å»ºä»»åŠ¡ç®¡ç†ç»„ä»¶"]
    D --> E["ä»»åŠ¡é˜Ÿåˆ— (asyncio.Queue)"]
    D --> F["ä»»åŠ¡åˆ›å»ºå®Œæˆä¿¡å·"]
    D --> G["æ—©åœä¿¡å·"]
    
    D --> H["å¯åŠ¨åŠ¨æ€ä»»åŠ¡åˆ›å»ºå™¨<br/>(_dynamic_task_creator)"]
    D --> I["å¯åŠ¨ä»»åŠ¡ç­‰å¾…ç®¡ç†å™¨<br/>(_wait_with_dynamic_task_creation)"]
    
    H --> J["è·å–æœåŠ¡å™¨è´Ÿè½½<br/>(get_load_callback)"]
    J --> K["è®¡ç®—æœåŠ¡å™¨å®¹é‡<br/>max_concurrent - current_load"]
    K --> L["æŒ‰æ¯”ä¾‹åˆ†é…ä»»åŠ¡åˆ°æœåŠ¡å™¨"]
    L --> M["åˆ›å»ºèŠå¤©å®Œæˆä»»åŠ¡<br/>(_submit_chat_completions_semaphore)"]
    M --> N["ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—"]
    N --> O{"æ˜¯å¦è¾¾åˆ°æ—©åœæ¡ä»¶?"}
    O -->|å¦| P["ç­‰å¾…æ‰¹æ¬¡åˆ›å»ºé—´éš”"]
    P --> J
    O -->|æ˜¯| Q["åœæ­¢åˆ›å»ºæ–°ä»»åŠ¡"]
    
    I --> R["ä»é˜Ÿåˆ—è·å–æ–°ä»»åŠ¡"]
    R --> S["ç­‰å¾…ä»»åŠ¡å®Œæˆ<br/>(asyncio.wait FIRST_COMPLETED)"]
    S --> T["æ£€æŸ¥ä»»åŠ¡ç»“æœ"]
    T --> LL["RewardCompletionCallbackå¤„ç†<br/>è°ƒç”¨math_verify_serviceè¯„åˆ†"]
    LL --> XX["æ›´æ–°promptå®ŒæˆçŠ¶æ€"]
    
    XX --> YY{"Evalæ¨¡å¼?"}
    YY -->|æ˜¯| ZZ["æ‰€æœ‰å®Œæˆçš„promptéƒ½åˆæ³•"]
    YY -->|å¦| AAA["æ£€æŸ¥åˆ†æ•°æ–¹å·®<br/>(_check_prompt_score_variance)"]
    AAA --> BBB{"æ–¹å·® > 1e-8?"}
    BBB -->|æ˜¯| CCC["æ ‡è®°ä¸ºåˆæ³•prompt"]
    BBB -->|å¦| DDD["æ ‡è®°ä¸ºéæ³•prompt"]
    
    ZZ --> EEE["æ›´æ–°åˆæ³•promptè®¡æ•°"]
    CCC --> EEE
    DDD --> EEE
    
    EEE --> FFF{"åˆæ³•promptæ•° >= Train batch size?"}
    FFF -->|æ˜¯,éEvalæ¨¡å¼| GGG["è§¦å‘æ—©åœ"]
    FFF -->|å¦| HHH["ç»§ç»­ç­‰å¾…æ›´å¤šä»»åŠ¡"]
    
    GGG --> III["è®¾ç½®æ—©åœä¿¡å·"]
    III --> KKK["åœ¨è°ƒç”¨ç«¯å–æ¶ˆæœªå¼€å§‹å’Œè¿›è¡Œä¸­çš„ä»»åŠ¡"]
    KKK --> LLL["æ”¶é›†è¢«å–æ¶ˆçš„request_id"]
    LLL --> MMM["è°ƒç”¨abort_callback<br/>ä¸­æ–­æœåŠ¡å™¨ç«¯è¯·æ±‚"]
    MMM --> NNN["ç­‰å¾…ä»»åŠ¡æ¸…ç†å®Œæˆ"]
    
    HHH --> R
    
    FFF -->|Evalæ¨¡å¼| OOO["ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ"]
    OOO --> PPP["RewardCompletionCallback.postprocess()"]
    NNN --> PPP
    
    PPP --> QQQ["å¤„ç†æ‰¹æ¬¡å¯¹è¯æ•°æ®"]
    QQQ --> RRR["æå–å“åº”å’Œè¯„åˆ†"]
    RRR --> SSS["TokenåŒ–å¤„ç†<br/>- promptå·¦å¡«å……<br/>- responseå³å¡«å……"]
    SSS --> TTT["ç”Ÿæˆattention_maskå’Œposition_ids"]
    TTT --> UUU["è¿‡æ»¤éæ³•promptæ•°æ®<br/>(_filter_invalid_prompts)"]
    UUU --> VVV["è¿”å›DataProtoç»“æœ<br/>åŒ…å«è¯„åˆ†ç»Ÿè®¡ä¿¡æ¯"]
    
    subgraph "è‡ªå®šä¹‰å›è°ƒå¤„ç†"
        WWW["RewardCompletionCallback<br/>å®æ—¶è¯„åˆ†å’Œæ•°æ®å¤„ç†"]
    end
    
    subgraph "å¤–éƒ¨æœåŠ¡"
        CCCC["math_verify_service.py<br/>(localhost:8000/score)"]
    end
    
    subgraph "æ—©åœä¼˜åŒ–"
        DDDD["åŸºäºåˆ†æ•°æ–¹å·®åˆ¤æ–­æœ‰æ•ˆPrompt"]
        EEEE["æ ¹æ®æœåŠ¡è´Ÿè½½åŠ¨æ€åˆ›å»ºä»»åŠ¡"]
        FFFF["ä¸­æ–­æœºåˆ¶"]
    end
    
    style A fill:#ff9999
    style LL fill:#ffcc99
    style GGG fill:#ffcc99
    style MMM fill:#99ccff
    style VVV fill:#99ff99
    style WWW fill:#ff99cc
    style CCCC fill:#99ff99
```