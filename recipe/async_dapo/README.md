# Async DAPO with Interruption Mechanism

è¿™æ˜¯ä¸€ä¸ªåŸºäºæ‰“æ–­æœºåˆ¶çš„å¼‚æ­¥DAPO (Direct Alignment with Preference Optimization) å¼ºåŒ–å­¦ä¹ æ–¹æ³•çš„å®ç°ã€‚è¯¥æ–¹æ³•é€šè¿‡åŠ¨æ€ä»»åŠ¡è°ƒåº¦ã€æ—©åœæœºåˆ¶å’Œè¯·æ±‚æ‰“æ–­ç­‰æŠ€æœ¯ï¼Œæ˜¾è‘—æå‡äº†å¤§æ¨¡å‹è®­ç»ƒçš„æ•ˆç‡å’Œèµ„æºåˆ©ç”¨ç‡ã€‚

## ğŸš€ ä¸»è¦ç‰¹æ€§

- **å¼‚æ­¥Rolloutæœºåˆ¶**: ä½¿ç”¨veRL çš„å¼‚æ­¥ Rollout engine
- **åŠ¨æ€ä»»åŠ¡åˆ›å»º**: æ ¹æ®æœåŠ¡å™¨è´Ÿè½½åŠ¨æ€åˆ†é…ä»»åŠ¡ï¼Œæé«˜èµ„æºåˆ©ç”¨ç‡
- **å’Œ DAPO ç»“åˆçš„æ—©åœç­–ç•¥**: åœ¨æ¯ä¸ª prompt rollout ç»“æŸæ—¶ç«‹å³è®¡ç®— reward æ–¹å·®ï¼Œå¹¶åœ¨æ”¶é›†åˆ°ä¸€ä¸ª batch åï¼Œåˆ™åœæ­¢ rollout æ¥é¿å…æ— æ•ˆè®¡ç®—

## ğŸ› ï¸ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒé…ç½®

```bash
# å®‰è£…åŸºæœ¬ä¾èµ–
pip install -e . 
pip install -U math-verify[antlr4_9_3]

# è®¾ç½®ç¯å¢ƒå˜é‡
export WANDB_API_KEY=<WANDB_API_KEY>
export MODEL_PATH=<MODEL_PATH>
export VLLM_USE_V1=1
export HOME_DIR=<PATH_TO_HOME>
```

### 2. æ•°æ®å‡†å¤‡

```bash
# åˆ›å»ºå­˜å‚¨ç›®å½•
mkdir -p <PATH_TO_HOME>/data/skywork_or1_1_5b_diff_sys
mkdir -p <PATH_TO_HOME>/data/aime24_sys

# è¿è¡Œæ•°æ®é›†æ„å»ºè„šæœ¬
python3 recipe/async_dapo/process_skywork.py --local_dir <PATH_TO_HOME>/data/skywork_or1_1_5b_diff_sys 
python3 recipe/async_dapo/process_aime24.py --local_dir <PATH_TO_HOME>/data/aime24_sys
```

### 3. è¿è¡Œè®­ç»ƒ

```bash
# å¯åŠ¨math verify server
nohup python3 recipe/async_dapo/math_verify_service.py > /dev/null 2>&1 &

# è¿è¡Œè®­ç»ƒè„šæœ¬
bash recipe/async_dapo/test_7b.sh
```

## âš™ï¸ æ ¸å¿ƒé…ç½®å‚æ•°

### å¼‚æ­¥Rollouté…ç½®
```bash
# æ¯ä¸ªpromptç”Ÿæˆçš„å›å¤æ•°é‡
n_resp_per_prompt=16

# åŠ¨æ€ä»»åŠ¡åˆ›å»ºé—´éš”ï¼ˆç§’ï¼‰
batch_creation_interval=10

# æ¯ä¸ªæœåŠ¡å™¨æœ€å¤§å¹¶å‘æ•°
max_concurrent_per_server=512
```


## ğŸ—ï¸ æ¶æ„è®¾è®¡

### 1. æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     DAPO Trainer                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                AsyncLLMServerManager                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ AsyncServer 0 â”‚ â”‚ AsyncServer 1 â”‚ â”‚ AsyncServer N â”‚    â”‚
â”‚  â”‚  (vLLM/SGLang)â”‚ â”‚  (vLLM/SGLang)â”‚ â”‚  (vLLM/SGLang)â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                ChatCompletionScheduler                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚             Dynamic Task Creator                    â”‚   â”‚
â”‚  â”‚  â€¢ Load-aware task allocation                      â”‚   â”‚
â”‚  â”‚  â€¢ Batch creation with intervals                   â”‚   â”‚
â”‚  â”‚  â€¢ Early stop signal handling                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚             Task Queue Manager                      â”‚   â”‚
â”‚  â”‚  â€¢ Concurrent task processing                      â”‚   â”‚
â”‚  â”‚  â€¢ Score variance-based validation                â”‚   â”‚
â”‚  â”‚  â€¢ Request interruption support                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. å¼‚æ­¥Rolloutæµç¨‹å›¾

```mermaid
graph TD
    A["AsyncLLMServerManager.generate_sequences()<br/>ä¸»å…¥å£"] --> B["ChatCompletionScheduler.generate_sequences()"]
    
    B --> C["åˆå§‹åŒ–é…ç½®<br/>- é‡‡æ ·å‚æ•°<br/>- æ—©åœé˜ˆå€¼<br/>- ä»»åŠ¡é˜Ÿåˆ—"]
    
    C --> D["åˆ›å»ºä»»åŠ¡ç®¡ç†ç»„ä»¶"]
    D --> E["ä»»åŠ¡é˜Ÿåˆ— (asyncio.Queue)"]
    D --> F["ä»»åŠ¡åˆ›å»ºå®Œæˆä¿¡å·"]
    D --> G["æ—©åœä¿¡å·"]
    
    D --> H["å¯åŠ¨åŠ¨æ€ä»»åŠ¡åˆ›å»ºå™¨<br/>(_dynamic_task_creator)"]
    D --> I["å¯åŠ¨ä»»åŠ¡ç­‰å¾…ç®¡ç†å™¨<br/>(_wait_with_dynamic_task_creation)"]
    
    H --> J["è·å–æœåŠ¡å™¨è´Ÿè½½<br/>(get_load_callback)"]
    J --> K["è®¡ç®—æœåŠ¡å™¨å®¹é‡<br/>max_concurrent - current_load"]
    K --> L["æŒ‰æ¯”ä¾‹åˆ†é…ä»»åŠ¡åˆ°æœåŠ¡å™¨"]
    L --> M["åˆ›å»ºèŠå¤©å®Œæˆä»»åŠ¡<br/>(_submit_chat_completions_semaphore)"]
    M --> N["ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—"]
    N --> O{"æ˜¯å¦è¾¾åˆ°æ—©åœæ¡ä»¶?"}
    O -->|å¦| P["ç­‰å¾…æ‰¹æ¬¡åˆ›å»ºé—´éš”"]
    P --> J
    O -->|æ˜¯| Q["åœæ­¢åˆ›å»ºæ–°ä»»åŠ¡"]
    
    I --> R["ä»é˜Ÿåˆ—è·å–æ–°ä»»åŠ¡"]
    R --> S["ç­‰å¾…ä»»åŠ¡å®Œæˆ<br/>(asyncio.wait FIRST_COMPLETED)"]
    S --> T["æ£€æŸ¥ä»»åŠ¡ç»“æœ"]
    T --> U["æ›´æ–°promptå®ŒæˆçŠ¶æ€"]
    U --> V{"éªŒè¯æ¨¡å¼?"}
    
    V -->|æ˜¯| W["æ‰€æœ‰å®Œæˆçš„promptéƒ½åˆæ³•"]
    V -->|å¦| X["æ£€æŸ¥åˆ†æ•°æ–¹å·®<br/>(_check_prompt_score_variance)"]
    X --> Y{"æ–¹å·® > 1e-8?"}
    Y -->|æ˜¯| Z["æ ‡è®°ä¸ºåˆæ³•prompt"]
    Y -->|å¦| AA["æ ‡è®°ä¸ºéæ³•prompt"]
    
    W --> BB["æ›´æ–°åˆæ³•promptè®¡æ•°"]
    Z --> BB
    AA --> BB
    
    BB --> CC{"åˆæ³•promptæ•° >= æœ€å°‘éœ€è¦æ•°?"}
    CC -->|æ˜¯,ééªŒè¯æ¨¡å¼| DD["è§¦å‘æ—©åœ"]
    CC -->|å¦| EE["ç»§ç»­ç­‰å¾…æ›´å¤šä»»åŠ¡"]
    
    DD --> FF["è®¾ç½®æ—©åœä¿¡å·"]
    FF --> GG["å–æ¶ˆé˜Ÿåˆ—ä¸­æœªå¼€å§‹ä»»åŠ¡"]
    GG --> HH["å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡"]
    HH --> II["æ”¶é›†è¢«å–æ¶ˆçš„request_id"]
    II --> JJ["è°ƒç”¨abort_callback<br/>ä¸­æ–­æœåŠ¡å™¨ç«¯è¯·æ±‚"]
    JJ --> KK["ç­‰å¾…ä»»åŠ¡æ¸…ç†å®Œæˆ"]
    
    EE --> R
    
    M --> LL["ToolCompletionCallbackå¤„ç†"]
    LL --> MM{"å·¥å…·è°ƒç”¨?"}
    MM -->|æ˜¯| NN["æ‰§è¡Œå·¥å…·"]
    NN --> OO["é‡æ–°æäº¤èŠå¤©è¯·æ±‚"]
    OO --> LL
    MM -->|å¦| PP["å¯¹è¯å®Œæˆ"]
    
    CC -->|éªŒè¯æ¨¡å¼| QQ["ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ"]
    QQ --> RR["åå¤„ç†æ•°æ®"]
    KK --> RR
    PP --> RR
    
    RR --> SS["è¿‡æ»¤éæ³•promptæ•°æ®<br/>(_filter_invalid_prompts)"]
    SS --> TT["ToolCompletionCallback.postprocess<br/>å¤„ç†tokenåŒ–å’Œæ©ç "]
    TT --> UU["è¿”å›DataProtoç»“æœ<br/>åŒ…å«ç»Ÿè®¡ä¿¡æ¯"]
    
    subgraph "æœåŠ¡å™¨ç®¡ç†"
        VV["AsyncLLMServerManager"]
        WW["å¤šä¸ªAsyncvLLMServerå®ä¾‹"]
        XX["è´Ÿè½½å‡è¡¡ç­–ç•¥"]
        YY["è¯·æ±‚è·¯ç”±"]
    end
    
    subgraph "å·¥å…·è°ƒç”¨æµç¨‹"
        ZZ["æ£€æµ‹tool_calls"]
        AAA["å¹¶è¡Œæ‰§è¡Œå·¥å…·"]
        BBB["æ”¶é›†å·¥å…·å“åº”"]
        CCC["é‡æ–°æäº¤è¯·æ±‚"]
    end
    
    subgraph "æ—©åœä¼˜åŒ–"
        DDD["åŸºäºåˆ†æ•°æ–¹å·®åˆ¤æ–­"]
        EEE["åŠ¨æ€ä»»åŠ¡åˆ›å»º"]
        FFF["æœåŠ¡å™¨è´Ÿè½½æ„ŸçŸ¥"]
        GGG["è¯·æ±‚ä¸­æ–­æœºåˆ¶"]
    end
    
    style A fill:#ff9999
    style DD fill:#ffcc99
    style JJ fill:#99ccff
    style UU fill:#99ff99
```